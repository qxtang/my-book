<!DOCTYPE html>
<html lang="zh-cn">
  <head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Book - 微信开发</title>

  <link rel="stylesheet" href="/my-book/resource/lib/github-markdown.min.css" />
  <link rel="stylesheet" href="/my-book/resource/style.css" />
  <link rel="stylesheet" href="/my-book/resource/lib/highlight/default.min.css" />
  <script src="/my-book/resource/lib/highlight/highlight.min.js"></script>
  <script src="/my-book/resource/lib/jquery.min.js"></script>
  <script src="//unpkg.com/viewerjs@1.10.4/dist/viewer.min.js"></script>
  <script src="//unpkg.com/jquery-viewer@1.0.1/dist/jquery-viewer.min.js"></script>
  <link rel="stylesheet" href="//unpkg.com/viewerjs@1.10.4/dist/viewer.min.css" />

  <link rel="manifest" href="/my-book/manifest.json" />
  <link rel="shortcut icon" type="image/x-icon" href="/my-book/resource/favicon.ico" />
  <link rel="bookmark" type="image/x-icon" href="/my-book/resource/favicon.ico" />
  <link rel="apple-touch-icon" href="/my-book/resource/favicon.ico" />

  <!-- 编译时间：4/1/2022, 11:33:45 AM -->

  <script>
    window.root = '/my-book';
    hljs.highlightAll();
  </script>

  <script src="/my-book/resource/script.js"></script>
</head>

  <body>
    <div class="content markdown-body"><h1 id="%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91" tabindex="-1"><a class="header-anchor" href="#%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a> 微信开发</h1>
<h1 id="%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" tabindex="-1"><a class="header-anchor" href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a> 小程序开发最佳实践</h1>
<ul>
<li>全局共享数据（非响应式），可以保存在 wx 对象，wx 就类似于网页的 window 对象</li>
</ul>
<h1 id="%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%88%86%E5%8C%85%E6%9C%BA%E5%88%B6" tabindex="-1"><a class="header-anchor" href="#%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%88%86%E5%8C%85%E6%9C%BA%E5%88%B6" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a> 微信小程序分包机制</h1>
<ul>
<li>某些情况下，开发者需要将小程序划分成不同的子包，在构建时打包成不同的分包，用户在使用时按需进行加载。</li>
<li>在构建小程序分包项目时，构建会输出一个或多个分包。每个使用分包小程序必定含有一个主包。所谓的主包，即放置默认启动页面/TabBar 页面，以及一些所有分包都需用到公共资源/JS 脚本；而分包则是根据开发者的配置进行划分。</li>
<li>在小程序启动时，默认会下载主包并启动主包内页面，当用户进入分包内某个页面时，客户端会把对应分包下载下来，下载完成后再进行展示。 目前小程序分包大小有以下限制：
<ul>
<li>整个小程序所有分包大小不超过 20M</li>
<li>单个分包/主包大小不能超过 2M</li>
</ul>
</li>
<li>对小程序进行分包，可以优化小程序首次启动的下载时间，以及在多团队共同开发时可以更好的解耦协作。</li>
</ul>
<h1 id="%E4%BB%80%E4%B9%88%E6%98%AF-wxs" tabindex="-1"><a class="header-anchor" href="#%E4%BB%80%E4%B9%88%E6%98%AF-wxs" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a> 什么是 wxs</h1>
<h1 id="%E5%85%AC%E4%BC%97%E5%8F%B7%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83" tabindex="-1"><a class="header-anchor" href="#%E5%85%AC%E4%BC%97%E5%8F%B7%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a> 公众号用户授权</h1>
<h2 id="1%E3%80%81%E7%94%A8%E6%88%B7%E5%90%8C%E6%84%8F%E6%8E%88%E6%9D%83%EF%BC%8C%E8%8E%B7%E5%8F%96-code" tabindex="-1"><a class="header-anchor" href="#1%E3%80%81%E7%94%A8%E6%88%B7%E5%90%8C%E6%84%8F%E6%8E%88%E6%9D%83%EF%BC%8C%E8%8E%B7%E5%8F%96-code" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a> 1、用户同意授权，获取 code</h2>
<ul>
<li>先在后台配置合法域名，页面需要运行在合法的域名下</li>
<li>开发的时候，可以修改电脑的 hosts 文件，将配置的域名映射为 127.0.0.1，即可进行本地开发</li>
<li>引导关注者打开一个微信的授权页面</li>
<li>页面链接会通过 url 传递一些参数 appid、redirect_uri、response_type 等</li>
</ul>
<h2 id="2%E3%80%81%E9%80%9A%E8%BF%87-code-%E6%8D%A2%E5%8F%96%E7%BD%91%E9%A1%B5%E6%8E%88%E6%9D%83-access_token" tabindex="-1"><a class="header-anchor" href="#2%E3%80%81%E9%80%9A%E8%BF%87-code-%E6%8D%A2%E5%8F%96%E7%BD%91%E9%A1%B5%E6%8E%88%E6%9D%83-access_token" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a> 2、通过 code 换取网页授权 access_token</h2>
<ul>
<li>把 code 传给后台</li>
<li>后台调微信接口传 code，获得网页授权 access_token 和 openid</li>
<li>请求微信用户信息接口，传上一步获得的 access_token 和 openid，响应给前端</li>
</ul>
<h1 id="%E6%8E%A5%E5%85%A5-js-sdk" tabindex="-1"><a class="header-anchor" href="#%E6%8E%A5%E5%85%A5-js-sdk" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a> 接入 js-sdk</h1>
<ul>
<li>登录后台配置合法域名，页面需要运行在这个域名</li>
<li>页面进入一个微信 js-sdk 的库</li>
<li>请求后台获取签名等参数的接口，把当前 url 发给后台</li>
<li>后台请求微信接口获取 access_token，再用 access_token 获取 jsapi_ticket</li>
<li>组装 noncestr、jsapi_ticket、timestamp、url，进行 sha1 签名得到 signature</li>
<li>把计算得到的东西发给前端</li>
<li>前端调用 wx.config 注入权限</li>
<li>通过 ready 接口处理成功验证、通过 error 接口处理失败验证</li>
</ul>
<h1 id="%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B" tabindex="-1"><a class="header-anchor" href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B" aria-hidden="true"><svg viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a> 小程序登录流程</h1>
<p>首次登录：</p>
<ul>
<li>首先需要调用小程序 api 接口 wx.login() 获取 临时登录凭证 code ，这个 code 是有过期时间的</li>
<li>将这个 code 回传到开发者服务器（就是请求开发者服务器的登录接口，通过凭证进而换取用户登录态信息，包括用户的唯一标识（openid）及本次登录的会话密钥（session_key）等</li>
<li>拿到开发者服务器传回来的会话密钥（session_key）之后，前端要保存 wx.setStorageSync(‘sessionKey’, ‘value’)</li>
</ul>
<p>再次登录：</p>
<ul>
<li>获取缓存中的 session_key，wx.getStorageSync(‘sessionKey’)</li>
<li>如果缓存中存在 session_key，那么调用小程序 api 接口 wx.checkSession()来判断登录态是否过期，回调成功说明当前 session_key 未过期，回调失败说明 session_key 已过期。登录态过期后前端需要再调用 wx.login()获取新的用户的 code，然后再向开发者服务器发起登录请求。</li>
<li>一般在项目开发，开发者服务器也会对用户的登录态做过期限制，所以这时在判断完微信服务器中登录态如果没有过期之后还要判断开发者服务器的登录态是否过期。（请求开发者服务器给定的接口进行请求判断就好）</li>
<li>无论是微信服务器过期了还是开发者服务器登录态过期了，都要像首次登录那样开始三步骤。所以注意封装代码</li>
</ul>
<p><div class="table-of-contents"><ul><li><a href="#%E5%BE%AE%E4%BF%A1%E5%BC%80%E5%8F%91"> 微信开发</a></li><li><a href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"> 小程序开发最佳实践</a></li><li><a href="#%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%88%86%E5%8C%85%E6%9C%BA%E5%88%B6"> 微信小程序分包机制</a></li><li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-wxs"> 什么是 wxs</a></li><li><a href="#%E5%85%AC%E4%BC%97%E5%8F%B7%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83"> 公众号用户授权</a><ul><li><a href="#1%E3%80%81%E7%94%A8%E6%88%B7%E5%90%8C%E6%84%8F%E6%8E%88%E6%9D%83%EF%BC%8C%E8%8E%B7%E5%8F%96-code"> 1、用户同意授权，获取 code</a></li><li><a href="#2%E3%80%81%E9%80%9A%E8%BF%87-code-%E6%8D%A2%E5%8F%96%E7%BD%91%E9%A1%B5%E6%8E%88%E6%9D%83-access_token"> 2、通过 code 换取网页授权 access_token</a></li></ul></li><li><a href="#%E6%8E%A5%E5%85%A5-js-sdk"> 接入 js-sdk</a></li><li><a href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"> 小程序登录流程</a></li></ul></div></p>
</div>
  </body>
</html>

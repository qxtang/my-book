<!DOCTYPE html>
<html lang="zh-cn">
  <head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QX&#39;s Book - Promise</title>

  <!-- styles -->
  <link rel="stylesheet" href="/my-book/resource/lib/github-markdown.min.css" />
  <link rel="stylesheet" href="/my-book/resource/style.css" />
  <link rel="stylesheet" href="/my-book/resource/lib/highlight.default.min.css" />
  <link rel="stylesheet" href="/my-book/resource/lib/viewerjs-1.10.5/viewer.min.css" />

  <!-- scripts -->
  <script src="/my-book/resource/lib/jquery.min.js"></script>

  <link rel="manifest" href="/my-book/manifest.json" />
  <link rel="shortcut icon" type="image/x-icon" href="/my-book/resource/favicon.ico" />
  <link rel="bookmark" type="image/x-icon" href="/my-book/resource/favicon.ico" />
  <link rel="apple-touch-icon" href="/my-book/resource/favicon.ico" />

  <!-- 编译时间：7/11/2022, 6:06:30 AM -->

  <script>
    window.root = '/my-book';

    // 提前把搜索数据库载入内存
    fetch(`${window.root}/dir_tree.json`)
      .then(function (res) {
        return res.json();
      })
      .then(function (res) {
        window.__doc_builder_dirTree__ = res;
      });
  </script>
</head>

  <body>
    <ul class="menu expand" id="menu">
      <div class="loading">
        <span>加载中...</span>
      </div>
      <div class="search_bar" id="search_bar">
        <input type="text" placeholder="search..." />
        <img
          class="clear"
          id="clear"
          src="/my-book/resource/icons/circle-xmark.svg"
          alt=""
        />
        <div class="search_result" id="search_result"></div>
      </div>
      
            <ul class="parent expand">
              <li id="工作沉淀" class="dir" title="工作沉淀">
                <span>工作沉淀</span>
                <div class="triangle"></div>
              </li>
              
          <li id="工作沉淀/ADB 通过 Wi-Fi 调试手机.md" class="children" title="ADB 通过 Wi-Fi 调试手机">
            <a href="/my-book/工作沉淀/ADB 通过 Wi-Fi 调试手机.html">ADB 通过 Wi-Fi 调试手机</a>
          </li>
        
          <li id="工作沉淀/Fiddler 真机调试微信 h5.md" class="children" title="Fiddler 真机调试微信 h5">
            <a href="/my-book/工作沉淀/Fiddler 真机调试微信 h5.html">Fiddler 真机调试微信 h5</a>
          </li>
        
          <li id="工作沉淀/GitFlow 笔记.md" class="children" title="GitFlow 笔记">
            <a href="/my-book/工作沉淀/GitFlow 笔记.html">GitFlow 笔记</a>
          </li>
        
          <li id="工作沉淀/Nginx 笔记.md" class="children" title="Nginx 笔记">
            <a href="/my-book/工作沉淀/Nginx 笔记.html">Nginx 笔记</a>
          </li>
        
          <li id="工作沉淀/动态校验企微应用可信域名.md" class="children" title="动态校验企微应用可信域名">
            <a href="/my-book/工作沉淀/动态校验企微应用可信域名.html">动态校验企微应用可信域名</a>
          </li>
        
          <li id="工作沉淀/工作中遇到问题汇总.md" class="children" title="工作中遇到问题汇总">
            <a href="/my-book/工作沉淀/工作中遇到问题汇总.html">工作中遇到问题汇总</a>
          </li>
        
          <li id="工作沉淀/敏捷迭代.md" class="children" title="敏捷迭代">
            <a href="/my-book/工作沉淀/敏捷迭代.html">敏捷迭代</a>
          </li>
        
          <li id="工作沉淀/最佳实践.md" class="children" title="最佳实践">
            <a href="/my-book/工作沉淀/最佳实践.html">最佳实践</a>
          </li>
        
          <li id="工作沉淀/登录方案.md" class="children" title="登录方案">
            <a href="/my-book/工作沉淀/登录方案.html">登录方案</a>
          </li>
        
          <li id="工作沉淀/设计稿多端适配方案.md" class="children" title="设计稿多端适配方案">
            <a href="/my-book/工作沉淀/设计稿多端适配方案.html">设计稿多端适配方案</a>
          </li>
        
            </ul>
          
            <ul class="parent expand">
              <li id="前端技术" class="dir" title="前端技术">
                <span>前端技术</span>
                <div class="triangle"></div>
              </li>
              
            <ul class="parent expand">
              <li id="前端技术/浏览器" class="dir" title="浏览器">
                <span>浏览器</span>
                <div class="triangle"></div>
              </li>
              
          <li id="前端技术/浏览器/事件循环.md" class="children" title="事件循环">
            <a href="/my-book/前端技术/浏览器/事件循环.html">事件循环</a>
          </li>
        
          <li id="前端技术/浏览器/浏览器.md" class="children" title="浏览器">
            <a href="/my-book/前端技术/浏览器/浏览器.html">浏览器</a>
          </li>
        
          <li id="前端技术/浏览器/浏览器架构.md" class="children" title="浏览器架构">
            <a href="/my-book/前端技术/浏览器/浏览器架构.html">浏览器架构</a>
          </li>
        
          <li id="前端技术/浏览器/浏览器缓存.md" class="children" title="浏览器缓存">
            <a href="/my-book/前端技术/浏览器/浏览器缓存.html">浏览器缓存</a>
          </li>
        
            </ul>
          
            <ul class="parent expand">
              <li id="前端技术/React" class="dir" title="React">
                <span>React</span>
                <div class="triangle"></div>
              </li>
              
          <li id="前端技术/React/Fiber.md" class="children" title="Fiber">
            <a href="/my-book/前端技术/React/Fiber.html">Fiber</a>
          </li>
        
          <li id="前端技术/React/Hooks.md" class="children" title="Hooks">
            <a href="/my-book/前端技术/React/Hooks.html">Hooks</a>
          </li>
        
          <li id="前端技术/React/React.md" class="children" title="React">
            <a href="/my-book/前端技术/React/React.html">React</a>
          </li>
        
            </ul>
          
            <ul class="parent expand">
              <li id="前端技术/Javascript" class="dir" title="Javascript">
                <span>Javascript</span>
                <div class="triangle"></div>
              </li>
              
          <li id="前端技术/Javascript/Promise.md" class="children" title="Promise">
            <a href="/my-book/前端技术/Javascript/Promise.html">Promise</a>
          </li>
        
          <li id="前端技术/Javascript/代理对.md" class="children" title="代理对">
            <a href="/my-book/前端技术/Javascript/代理对.html">代理对</a>
          </li>
        
          <li id="前端技术/Javascript/其他.md" class="children" title="其他">
            <a href="/my-book/前端技术/Javascript/其他.html">其他</a>
          </li>
        
          <li id="前端技术/Javascript/原型链和继承.md" class="children" title="原型链和继承">
            <a href="/my-book/前端技术/Javascript/原型链和继承.html">原型链和继承</a>
          </li>
        
          <li id="前端技术/Javascript/数据类型.md" class="children" title="数据类型">
            <a href="/my-book/前端技术/Javascript/数据类型.html">数据类型</a>
          </li>
        
          <li id="前端技术/Javascript/模块.md" class="children" title="模块">
            <a href="/my-book/前端技术/Javascript/模块.html">模块</a>
          </li>
        
          <li id="前端技术/Javascript/正则表达式.md" class="children" title="正则表达式">
            <a href="/my-book/前端技术/Javascript/正则表达式.html">正则表达式</a>
          </li>
        
          <li id="前端技术/Javascript/闭包.md" class="children" title="闭包">
            <a href="/my-book/前端技术/Javascript/闭包.html">闭包</a>
          </li>
        
            </ul>
          
          <li id="前端技术/AST抽象语法树.md" class="children" title="AST抽象语法树">
            <a href="/my-book/前端技术/AST抽象语法树.html">AST抽象语法树</a>
          </li>
        
          <li id="前端技术/Babel.md" class="children" title="Babel">
            <a href="/my-book/前端技术/Babel.html">Babel</a>
          </li>
        
          <li id="前端技术/Browserslist.md" class="children" title="Browserslist">
            <a href="/my-book/前端技术/Browserslist.html">Browserslist</a>
          </li>
        
          <li id="前端技术/CSS.md" class="children" title="CSS">
            <a href="/my-book/前端技术/CSS.html">CSS</a>
          </li>
        
          <li id="前端技术/DOM 变动观察器（Mutation observer）.md" class="children" title="DOM 变动观察器（Mutation observer）">
            <a href="/my-book/前端技术/DOM 变动观察器（Mutation observer）.html">DOM 变动观察器（Mutation observer）</a>
          </li>
        
          <li id="前端技术/Flex布局.md" class="children" title="Flex布局">
            <a href="/my-book/前端技术/Flex布局.html">Flex布局</a>
          </li>
        
          <li id="前端技术/Less.md" class="children" title="Less">
            <a href="/my-book/前端技术/Less.html">Less</a>
          </li>
        
          <li id="前端技术/NodeJS.md" class="children" title="NodeJS">
            <a href="/my-book/前端技术/NodeJS.html">NodeJS</a>
          </li>
        
          <li id="前端技术/Redux.md" class="children" title="Redux">
            <a href="/my-book/前端技术/Redux.html">Redux</a>
          </li>
        
          <li id="前端技术/Typescript.md" class="children" title="Typescript">
            <a href="/my-book/前端技术/Typescript.html">Typescript</a>
          </li>
        
          <li id="前端技术/URL对象.md" class="children" title="URL对象">
            <a href="/my-book/前端技术/URL对象.html">URL对象</a>
          </li>
        
          <li id="前端技术/Vue.md" class="children" title="Vue">
            <a href="/my-book/前端技术/Vue.html">Vue</a>
          </li>
        
          <li id="前端技术/Webpack.md" class="children" title="Webpack">
            <a href="/my-book/前端技术/Webpack.html">Webpack</a>
          </li>
        
          <li id="前端技术/lerna.md" class="children" title="lerna">
            <a href="/my-book/前端技术/lerna.html">lerna</a>
          </li>
        
          <li id="前端技术/npm.md" class="children" title="npm">
            <a href="/my-book/前端技术/npm.html">npm</a>
          </li>
        
          <li id="前端技术/函数式编程.md" class="children" title="函数式编程">
            <a href="/my-book/前端技术/函数式编程.html">函数式编程</a>
          </li>
        
          <li id="前端技术/微信开发.md" class="children" title="微信开发">
            <a href="/my-book/前端技术/微信开发.html">微信开发</a>
          </li>
        
          <li id="前端技术/微前端.md" class="children" title="微前端">
            <a href="/my-book/前端技术/微前端.html">微前端</a>
          </li>
        
          <li id="前端技术/性能优化.md" class="children" title="性能优化">
            <a href="/my-book/前端技术/性能优化.html">性能优化</a>
          </li>
        
          <li id="前端技术/手写题.md" class="children" title="手写题">
            <a href="/my-book/前端技术/手写题.html">手写题</a>
          </li>
        
          <li id="前端技术/文件上传&下载.md" class="children" title="文件上传&下载">
            <a href="/my-book/前端技术/文件上传&下载.html">文件上传&下载</a>
          </li>
        
          <li id="前端技术/柯里化.md" class="children" title="柯里化">
            <a href="/my-book/前端技术/柯里化.html">柯里化</a>
          </li>
        
          <li id="前端技术/虚拟列表.md" class="children" title="虚拟列表">
            <a href="/my-book/前端技术/虚拟列表.html">虚拟列表</a>
          </li>
        
          <li id="前端技术/设计模式.md" class="children" title="设计模式">
            <a href="/my-book/前端技术/设计模式.html">设计模式</a>
          </li>
        
            </ul>
          
          <li id="其他.md" class="children" title="其他">
            <a href="/my-book/其他.html">其他</a>
          </li>
        
          <li id="单元测试.md" class="children" title="单元测试">
            <a href="/my-book/单元测试.html">单元测试</a>
          </li>
        
          <li id="数据结构与算法.md" class="children" title="数据结构与算法">
            <a href="/my-book/数据结构与算法.html">数据结构与算法</a>
          </li>
        
          <li id="网络.md" class="children" title="网络">
            <a href="/my-book/网络.html">网络</a>
          </li>
        
      <li id="index.md" class="children about">
        <a href="/my-book/">关于</a>
      </li>
    </ul>
    <div class="drager" id="drager">
      <div class="switcher btn" id="switcher" title="展开或收起"></div>
      <div class="expand-all btn" id="expand-all" title="展开所有"></div>
      <div class="collapse-all btn" id="collapse-all" title="收起所有"></div>
    </div>
    <div class="mobile_menu" id="mobile_menu">
      <img src="/my-book/resource/icons/bars.svg" alt="" />
    </div>
    <div class="content markdown-body">
      <h1 id="%E5%8F%82%E8%80%83" tabindex="-1"><a class="header-anchor" href="#%E5%8F%82%E8%80%83">参考</a></h1>
<ul>
<li><a href="https://es6.ruanyifeng.com/#docs/promise" target="_blank">https://es6.ruanyifeng.com/#docs/promise</a></li>
</ul>
<h1 id="%E6%8F%8F%E8%BF%B0" tabindex="-1"><a class="header-anchor" href="#%E6%8F%8F%E8%BF%B0">描述</a></h1>
<ul>
<li>用来解决 es5 时期的回调地狱</li>
<li>实例化一个 Promise 需要传入一个函数，代码在这个函数中执行，这个函数往往接收两个参数 resolve 和 reject，当作函数来执行</li>
<li>在函数中代码执行成功了，调用 resolve 函数，可以把 Promise 的状态变为已成功，通过参数把成功的结果传递出去，能在这个 Promise 对象的 then 方法中获取，then 方法可以链式调用多次，then 方法接受一个函数作为参数，这个函数的参数就是 resolve 传递出来的结果</li>
<li>在函数中业务代码执行失败了，调用 reject 函数，可以把 Promise 的状态变为已失败，通过参数把失败的结果传递出去，能在这个 Promise 对象的 catch 方法中获取，catch 方法和 then 方法用法一致，也是接受一个函数作为参数</li>
<li>无论结果如何都会走 finally 方法</li>
<li>Promise.all：接受一个数组作为参数，都是 Promise 实例，调用 Promise.all 的时候，这些实例会一起开始执行，返回一个结果数组，只有全部实例的状态是已完成，结果的状态才会是已完成，只要有一个失败，结果就是失败</li>
<li>Promise.race：接受一个数组作为参数，都是 Promise 实例，返回一个结果数组，调用 Promise.race 的时候，传进去的实例是竞赛关系，哪个结果获得的快，就返回那个结果</li>
<li>Promise.resolve()：直接返回一个成功状态的 Promise 对象，接受一个参数，这个参数可以是：成功的结果、Promise 实例、不带有参数</li>
<li>Promise.reject()：失败，同上</li>
</ul>
<h1 id="promise-%E5%AE%9E%E7%8E%B0%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E5%8E%9F%E7%90%86" tabindex="-1"><a class="header-anchor" href="#promise-%E5%AE%9E%E7%8E%B0%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E5%8E%9F%E7%90%86">Promise 实现链式调用原理</a></h1>
<ul>
<li>每个方法其实都是返回一个新的 Promise 对象</li>
</ul>
<h1 id="%E6%89%8B%E5%86%99-promise" tabindex="-1"><a class="header-anchor" href="#%E6%89%8B%E5%86%99-promise">手写 Promise</a></h1>
<pre><code class="language-jsx"><span class="hljs-comment">// 在这里用Symbol定义三种状态，防止外部改变状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Pending</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;Pending&#x27;</span>);
<span class="hljs-comment">// 进行中</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Fulfilled</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;Fulfilled&#x27;</span>);
<span class="hljs-comment">// 已成功</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Rejected</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;Rejected&#x27;</span>);
<span class="hljs-comment">// 已失败</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleValue</span> = (<span class="hljs-params">promise, x, resolve, reject</span>) =&gt; {
  <span class="hljs-comment">// 循环引用，自己等待自己完成，会出错，用reject传递出错误原因</span>
  <span class="hljs-keyword">if</span> (promise === x) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;检测到Promise的链式循环引用&#x27;</span>));
  }
  <span class="hljs-comment">// 确保递归解析中只传递出去一次值</span>
  <span class="hljs-keyword">let</span> once = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">if</span> ((x !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">&#x27;object&#x27;</span>) || <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">&#x27;function&#x27;</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 防止重复去读取x.then</span>
      <span class="hljs-keyword">let</span> then = x.<span class="hljs-property">then</span>;
      <span class="hljs-comment">// 判断x是不是Promise</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> then === <span class="hljs-string">&#x27;function&#x27;</span>) {
        <span class="hljs-comment">//调用then实例方法处理Promise执行结果</span>
        then.<span class="hljs-title function_">call</span>(
          x,
          <span class="hljs-function">(<span class="hljs-params">y</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (once) <span class="hljs-keyword">return</span>;
            once = <span class="hljs-literal">true</span>;
            <span class="hljs-comment">// 防止Promise中Promise执行成功后又传递一个Promise过来，</span>
            <span class="hljs-comment">// 要做递归解析。</span>
            <span class="hljs-title function_">handleValue</span>(promise, y, resolve, reject);
          },
          <span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (once) <span class="hljs-keyword">return</span>;
            once = <span class="hljs-literal">true</span>;
            <span class="hljs-title function_">reject</span>(r);
          }
        );
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 如果x是个普通对象，直接调用resolve(x)</span>
        <span class="hljs-title function_">resolve</span>(x);
      }
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-keyword">if</span> (once) <span class="hljs-keyword">return</span>;
      once = <span class="hljs-literal">true</span>;
      <span class="hljs-title function_">reject</span>(err);
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 如果x是个原始值，直接调用resolve(x)</span>
    <span class="hljs-title function_">resolve</span>(x);
  }
};
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Promise</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-title class_">Pending</span>;
    <span class="hljs-comment">//存储 Promise 的状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>;
    <span class="hljs-comment">//存储executor函数中业务代码执行成功的结果</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = <span class="hljs-literal">undefined</span>;
    <span class="hljs-comment">//存储executor函数中业务代码执行失败的原因</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilled</span> = [];
    <span class="hljs-comment">//executor函数中业务代码执行成功回调函数的集合</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejected</span> = [];
    <span class="hljs-comment">//executor函数中业务代码执行失败回调函数的集合</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
      <span class="hljs-comment">// 只有当状态为 Pending 才会改变，来保证一旦状态改变就不会再变。</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-title class_">Pending</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-title class_">Fulfilled</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;
        <span class="hljs-comment">// 依次调用成功回调函数</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilled</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> <span class="hljs-title function_">fn</span>());
      }
    };
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">value</span>) =&gt; {
      <span class="hljs-comment">// 只有当状态为 Pending 才会改变，来保证一旦状态改变就不会再变。</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-title class_">Pending</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-title class_">Rejected</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = value;
        <span class="hljs-comment">// 依次调用失败回调函数</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejected</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> <span class="hljs-title function_">fn</span>());
      }
    };
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">executor</span>(resolve, reject);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title function_">reject</span>(error);
    }
  }
  <span class="hljs-title function_">then</span>(<span class="hljs-params">onFulfilled, onRejected</span>) {
    onFulfilled = <span class="hljs-keyword">typeof</span> onFulfilled === <span class="hljs-string">&#x27;function&#x27;</span> ? onFulfilled : <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v;
    onRejected =
      <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">&#x27;function&#x27;</span>
        ? onRejected
        : <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-keyword">throw</span> err;
          };
    <span class="hljs-keyword">let</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-title class_">Fulfilled</span>) {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">let</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);
            <span class="hljs-title function_">handleValue</span>(promise, x, resolve, reject);
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">reject</span>(error);
          }
        }, <span class="hljs-number">0</span>);
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-title class_">Rejected</span>) {
        <span class="hljs-keyword">if</span> (onRejected &amp;&amp; <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">&#x27;function&#x27;</span>) {
          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">try</span> {
              <span class="hljs-keyword">let</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>);
              <span class="hljs-title function_">handleValue</span>(promise, x, resolve, reject);
            } <span class="hljs-keyword">catch</span> (error) {
              <span class="hljs-title function_">reject</span>(error);
            }
          }, <span class="hljs-number">0</span>);
        }
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-title class_">Pending</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilled</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">try</span> {
              <span class="hljs-keyword">let</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);
              <span class="hljs-title function_">handleValue</span>(promise, x, resolve, reject);
            } <span class="hljs-keyword">catch</span> (error) {
              <span class="hljs-title function_">reject</span>(error);
            }
          }, <span class="hljs-number">0</span>);
        });
        <span class="hljs-keyword">if</span> (onRejected &amp;&amp; <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">&#x27;function&#x27;</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejected</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
              <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">let</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>);
                <span class="hljs-title function_">handleValue</span>(promise, x, resolve, reject);
              } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-title function_">reject</span>(error);
              }
            }, <span class="hljs-number">0</span>);
          });
        }
      }
    });
    <span class="hljs-keyword">return</span> promise;
  }
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-params">param</span>) {
    <span class="hljs-keyword">if</span> (param <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
      <span class="hljs-keyword">return</span> param;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (param &amp;&amp; <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(param) === <span class="hljs-string">&#x27;[object Object]&#x27;</span> &amp;&amp; <span class="hljs-keyword">typeof</span> param.<span class="hljs-property">then</span> === <span class="hljs-string">&#x27;function&#x27;</span>) {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          param.<span class="hljs-title function_">then</span>(resolve, reject);
        }, <span class="hljs-number">0</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">resolve</span>(param);
      }
    });
  }
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">reject</span>(<span class="hljs-params">param</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-title function_">reject</span>(param);
    });
  }
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">all</span>(<span class="hljs-params">promises</span>) {
    <span class="hljs-comment">//将参数promises转为一个真正的数组</span>
    promises = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(promises);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> length = promises.<span class="hljs-property">length</span>;
      <span class="hljs-keyword">let</span> value = [];
      <span class="hljs-keyword">if</span> (length) {
        value = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, { <span class="hljs-attr">length</span>: length });
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {
          <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(promises[i]).<span class="hljs-title function_">then</span>(
            <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
              value[i] = res;
              <span class="hljs-keyword">if</span> (value.<span class="hljs-property">length</span> == length) {
                <span class="hljs-title function_">resolve</span>(value);
              }
            },
            <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
              <span class="hljs-title function_">reject</span>(err);
              <span class="hljs-keyword">return</span>;
            }
          );
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">resolve</span>(value);
      }
    });
  }
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">race</span>(<span class="hljs-params">promises</span>) {
    <span class="hljs-comment">//将参数promises转为一个真正的数组</span>
    promises = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(promises);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> length = promises.<span class="hljs-property">length</span>;
      <span class="hljs-keyword">if</span> (length) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {
          <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(promises[i]).<span class="hljs-title function_">then</span>(
            <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
              <span class="hljs-title function_">resolve</span>(res);
              <span class="hljs-keyword">return</span>;
            },
            <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
              <span class="hljs-title function_">reject</span>(err);
              <span class="hljs-keyword">return</span>;
            }
          );
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span>;
      }
    });
  }
}
</code></pre>
<h1 id="promise.catch-%E6%98%AF%E4%B8%8D%E6%98%AF%E5%BE%AE%E4%BB%BB%E5%8A%A1" tabindex="-1"><a class="header-anchor" href="#promise.catch-%E6%98%AF%E4%B8%8D%E6%98%AF%E5%BE%AE%E4%BB%BB%E5%8A%A1">promise.catch 是不是微任务</a></h1>
<ul>
<li>是的</li>
</ul>

      
        <div class="btt withToc" id="btt"></div>
      
    </div>
    
    <div class="table-of-contents"><ul><li title="参考"><a href="#%E5%8F%82%E8%80%83" data-anchor="#%E5%8F%82%E8%80%83">参考</a></li><li title="描述"><a href="#%E6%8F%8F%E8%BF%B0" data-anchor="#%E6%8F%8F%E8%BF%B0">描述</a></li><li title="Promise 实现链式调用原理"><a href="#promise-%E5%AE%9E%E7%8E%B0%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E5%8E%9F%E7%90%86" data-anchor="#promise-%E5%AE%9E%E7%8E%B0%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E5%8E%9F%E7%90%86">Promise 实现链式调用原理</a></li><li title="手写 Promise"><a href="#%E6%89%8B%E5%86%99-promise" data-anchor="#%E6%89%8B%E5%86%99-promise">手写 Promise</a></li><li title="promise.catch 是不是微任务"><a href="#promise.catch-%E6%98%AF%E4%B8%8D%E6%98%AF%E5%BE%AE%E4%BB%BB%E5%8A%A1" data-anchor="#promise.catch-%E6%98%AF%E4%B8%8D%E6%98%AF%E5%BE%AE%E4%BB%BB%E5%8A%A1">promise.catch 是不是微任务</a></li></ul></div>
    

    <!-- bottom scripts -->
    <script src="/my-book/resource/lib/mark.js-8.11.1/jquery.mark.min.js"></script>
    <script src="/my-book/resource/lib/viewerjs-1.10.5/viewer.min.js"></script>
    <script src="/my-book/resource/lib/jquery-viewer-1.0.1/jquery-viewer.min.js"></script>
    <script src="/my-book/resource/script.js"></script>
  </body>
</html>
